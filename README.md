# üó∫ Location Service ‚Äî Microservice for Geocoding & Nearby Objects (OSM + Redis Pipeline)

Location Service ‚Äî –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è:  
–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–π–æ–Ω –≥–æ—Ä–æ–¥–∞ –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º, –Ω–∞—Ö–æ–¥–∏—Ç –±–ª–∏–∂–∞–π—à–∏–µ –æ–±—ä–µ–∫—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–º–µ—Ç—Ä–æ, –º–∞–≥–∞–∑–∏–Ω—ã, –∞–ø—Ç–µ–∫–∏, –¥–µ—Ç—Å–∫–∏–µ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è –∏ —Ç.–ø.), –∞ –∑–∞—Ç–µ–º –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞–µ—Ç enriched-–ø–æ—Å—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–ª—å—à–µ –≤ Redis Stream.

–°–µ—Ä–≤–∏—Å —è–≤–ª—è–µ—Ç—Å—è **–≤—Ç–æ—Ä—ã–º —ç—Ç–∞–ø–æ–º –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö** –≤ Real Estate Rent Pipeline.

---

# üöÄ –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### ‚úî –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø–æ–ª–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏–∑ Redis Stream `raw_posts`
–°–µ—Ä–≤–∏—Å XREAD ‚Üí —á–∏—Ç–∞–µ—Ç –Ω–æ–≤—ã–µ —Å—ã—Ä—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è, –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ Parser Service.

### ‚úî –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–π–æ–Ω–∞ –≥–æ—Ä–æ–¥–∞ (district) –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º  
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è GeoJSON —Å –ø–æ–ª–∏–≥–æ–Ω–∞–º–∏ —Ä–∞–π–æ–Ω–æ–≤ –≥–æ—Ä–æ–¥–∞.  
–û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ **shapely**:

- –¢–æ—á–∫–∞ ‚Üí –ø–æ–ø–∞–¥–∞–µ—Ç –ª–∏ –≤ –≥–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π –ø–æ–ª–∏–≥–æ–Ω?
- –ï—Å–ª–∏ –ø–æ–ø–∞–¥–∞–µ—Ç ‚Üí —Ä–∞–π–æ–Ω –Ω–∞–π–¥–µ–Ω  
- –ò–Ω–∞—á–µ: —Ä–∞–π–æ–Ω = –ø—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞

### ‚úî –ü–æ–∏—Å–∫ –±–ª–∏–∂–∞–π—à–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤ (—Ä–∞–¥–∏—É—Å 500 –º–µ—Ç—Ä–æ–≤):
–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
- subway  
- pharmacy  
- kindergarten  
- school  
- bank  
- supermarket / convenience / mall  

–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ OpenStreetMap (*.osm*), –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ —á–µ—Ä–µ–∑:

- **osmium** ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ OSM
- **shapely** ‚Äî –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –≥–µ–æ–º–µ—Ç—Ä–∏–∏
- **haversine distance** ‚Äî —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –ø–æ —Å—Ñ–µ—Ä–µ

### ‚úî –°–æ–∑–¥–∞–Ω–∏–µ enriched –ø–æ—Å—Ç–∞
–°–µ—Ä–≤–∏—Å –¥–æ–ø–æ–ª–Ω—è–µ—Ç –∏—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Å—Ç –ø–æ–ª—è–º–∏:
- city_district
- nearby_subway
- nearby_pharmacy
- nearby_kindergarten
- nearby_school
- nearby_bank
- nearby_shop

–∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —á–µ—Ä–µ–∑ JSON.

### ‚úî –û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –≤ Redis Stream `geo_ready_posts`
–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø: Posts Service.

---

# üîÑ –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö –≤ —Å–∏—Å—Ç–µ–º–µ
```yaml
Parser Service
‚Üì
Redis Stream: raw_posts
‚Üì
Location Service ‚Üê (–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–π–æ–Ω–∞ + –ø–æ–∏—Å–∫ –æ–±—ä–µ–∫—Ç–æ–≤ OSM)
‚Üì
Redis Stream: geo_ready_posts
‚Üì
Posts Service
‚Üì
Telegram Service (—Ä–∞—Å—Å—ã–ª–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º)
```


Location Service ‚Äî –∫–ª—é—á–µ–≤–æ–π –º–æ–¥—É–ª—å –æ–±–æ–≥–∞—â–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö.

---

# üõ† –ò—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏

- **osmium** ‚Äî –ø–∞—Ä—Å–∏–Ω–≥ OSM-—Ñ–∞–π–ª–æ–≤
- **shapely** ‚Äî —Ä–∞–±–æ—Ç–∞ —Å –≥–µ–æ–º–µ—Ç—Ä–∏–µ–π –ø–æ–ª–∏–≥–æ–Ω–æ–≤
- **haversine formula** ‚Äî –≤—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è –ø–æ —Å—Ñ–µ—Ä–µ
- **FastAPI**
- **AsyncIO**
- **Redis Streams (XREAD / XADD)**
- **Docker**
- **Prometheus**

---

# üì¶ –û—Å–Ω–æ–≤–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## 1Ô∏è‚É£ –ü–∞—Ä—Å–∏–Ω–≥ OSM –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–∏—Å–∞  

Location Service –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `.osm` —Ñ–∞–π–ª–∞:

```python
handler = POIHandler()
handler.apply_file(settings.OSM_FILE, locations=True)
POI_DATA = {
    "subway": [...],
    "pharmacy": [...],
    "school": [...],
    ...
}
```
## 2Ô∏è‚É£ –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
```python
response = await redis.xread(streams={RAW_STREAM: last_id}, block=0, count=1)
RAW_STREAM = "raw_posts".
```

–ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è:

1. –î–æ—Å—Ç–∞—ë—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã lat, lon.
2. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ä–∞–π–æ–Ω —á–µ—Ä–µ–∑ GeoJSON.
3. –ò—â–µ—Ç –æ–±—ä–µ–∫—Ç—ã –≤ —Ä–∞–¥–∏—É—Å–µ —á–µ—Ä–µ–∑ —Ñ—É–Ω–∫—Ü–∏—é find_nearby().
4. –§–æ—Ä–º–∏—Ä—É–µ—Ç enriched post.
5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç enriched post –≤ geo_ready_posts.

# üì° API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã
## üîπ GET /geocode/
```bash
/geocode/?lat=53.917&lon=27.594&city=minsk
```
–û—Ç–≤–µ—Ç:
```json
{
  "district": "–°–æ–≤–µ—Ç—Å–∫–∏–π —Ä–∞–π–æ–Ω",
  "nearby": {
    "subway": ["–£—Ä—É—á—å–µ"],
    "pharmacy": ["–ê–ø—Ç–µ–∫–∞ N"],
    "school": ["–®–∫–æ–ª–∞ ‚Ññ23"],
    ...
  }
}
```

## üîπ GET /nearest/
–¢–æ–ª—å–∫–æ –±–ª–∏–∂–∞–π—à–∏–µ –æ–±—ä–µ–∫—Ç—ã (–±–µ–∑ —Ä–∞–π–æ–Ω–∞).
```bash
/nearest/?lat=53.917&lon=27.594&radius=500
```

## üîπ GET /district/
–¢–æ–ª—å–∫–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ä–∞–π–æ–Ω–∞.
```bash
/district/?lat=53.917&lon=27.594&city=minsk
```

# üß† –û—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
‚úî find_nearby(lat, lon, radius)

–ù–∞—Ö–æ–¥–∏—Ç –±–ª–∏–∂–∞–π—à–∏–µ –æ–±—ä–µ–∫—Ç—ã –∏–∑ POI_DATA.

‚úî get_district_by_point(lat, lon, city)

–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–Ω–æ—Å—Ç—å —Ç–æ—á–∫–∏ –∫ —Ä–∞–π–æ–Ω—É –ø–æ GeoJSON –ø–æ–ª–∏–≥–æ–Ω–∞–º.

‚úî geolocation_consumer()

–û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Å—å—é–º–µ—Ä Redis Streams.


# üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
```nginx
location-service/
‚îÇ
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ routers/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ geocode.py
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ district.py
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ nearest.py
‚îÇ   ‚îú‚îÄ‚îÄ services/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ geocode_service.py
‚îÇ   ‚îú‚îÄ‚îÄ consumers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ geolocation_consumer.py
‚îÇ   ‚îú‚îÄ‚îÄ redis/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ redis_client.py
‚îÇ   ‚îú‚îÄ‚îÄ settings/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings.py
‚îÇ   ‚îú‚îÄ‚îÄ logs/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ logger.py
‚îÇ   ‚îî‚îÄ‚îÄ main.py
‚îÇ
‚îú‚îÄ‚îÄ geo_files/*.geojson            # —É–¥–µ—Ä–∂–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–æ–≤
‚îú‚îÄ‚îÄ *.osm                          # OSM-–¥–∞—Ç–∞
‚îú‚îÄ‚îÄ Dockerfile
‚îî‚îÄ‚îÄ README.md
```

# üê≥ Docker Setup
## 1Ô∏è‚É£ –§–∞–π–ª .env
```env
OSM_FILE=./belarus.osm
REDIS_SERVICE=redis://redis:6379
SERVICE_NAME=location-service
```
## 2Ô∏è‚É£ –ó–∞–ø—É—Å–∫
```bash
docker build -t location-service .
docker run -p 8003:8000 --env-file .env location-service
```

# üìä –ú–µ—Ç—Ä–∏–∫–∏ Prometheus
–î–æ—Å—Ç—É–ø–Ω—ã –ø–æ:
```bash
/metrics
```
–°–æ–¥–µ—Ä–∂–∞—Ç:
- –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö RAW posts
- –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- —Å—Ç–∞—Ç—É—Å-–∫–æ–¥—ã
- latency FastAPI

# üí° –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è
- –î–æ–±–∞–≤–∏—Ç—å –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–π–æ–Ω–æ–≤ ‚Üí —É—Å–∫–æ—Ä–∏—Ç –æ–±—Ä–∞–±–æ—Ç–∫—É
- –ü—Ä–µ–¥–∑–∞–≥—Ä—É–∂–∞—Ç—å POI –≤ Redis –∏–ª–∏ Postgres
- –î–æ–±–∞–≤–∏—Ç—å –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–¥–∏—É—Å –ø–æ–∏—Å–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
- –í—ã–Ω–µ—Å—Ç–∏ –∫–æ–Ω—Å—å—é–º–µ—Ä –Ω–∞ Celery –∏–ª–∏ –æ—Ç–¥–µ–ª—å–Ω—ã–π worker
- –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –Ω–∞ GeoJSON / —Ç–æ—á–∫–∏ / –≥—Ä–∞–Ω–∏—Ü—ã